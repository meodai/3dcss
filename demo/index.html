
<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<style>
* {
  margin: 0;
  padding: 0;
}
body, html {
  background: #16161D;
  color: #fff;
  height: 100%;
}

.cam {
  position: absolute;
  top: 0; right: 0; bottom: 0; left: 0;
  overflow: hidden;
}

h1 {
  margin: 0;
  font-size: 14vw;
  position: absolute;
  top: 50%;
  left: 50%;
  -webkit-transform: translate(-50%, -50%);
      -ms-transform: translate(-50%, -50%);
          transform: translate(-50%, -50%);
  white-space: nowrap;
}

.mother {
  position: absolute;
  width: 80%;
  height: 80%;
  top: 50%;
  left: 50%;
  -webkit-transform: translate(-50%, -50%);
      -ms-transform: translate(-50%, -50%);
          transform: translate(-50%, -50%);
  -webkit-transform-style: preserve-3d;
          transform-style: preserve-3d;
}

.cloud, .cloudPart {
  position: absolute;
  top: 0;
  left: 0;
}

.cloud {
  -webkit-transform-style: preserve-3d;
          transform-style: preserve-3d;
}

.cloudPart {
  background: url(https://s3-us-west-2.amazonaws.com/s.cdpn.io/102565/cloud.png) no-repeat;
  background-size: 100% auto;
}
</style></head>
<body>
<div class="cam">
  <div class="mother js-mother"></div>
</div>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="../3dcss.js"></script>
<script>
function createCloud (minParticles, maxParticles, depth){
  var x,y,z,a,s, $cloud, $cloudPart,
      cloudHtml = "<div class='cloud'></div>", cloudPartHtml = "<div class='cloudPart'></div>",
      cloud, cloudPart;

  $cloud = $(cloudHtml);
  cloud = new css3d.Node($cloud[0]);
  depth = depth || 0;

  for(i = 0; i < (minParticles || 2) + Math.round( Math.random() * ( maxParticles || 10) ); i++){
    $cloudPart = $(cloudPartHtml);

    x = 256 - ( Math.random() * 256 );
    y = 256 - ( Math.random() * 256 );
    z = 100 - ( Math.random() * 200 );
    a = Math.random() * 360;
    s = 0.25 + Math.random();

    cloudPart = new css3d.Node($cloudPart[0]);
    cloudPart.set('transform', x - (window.innerWidth * .35) * .5,y - (window.innerHeight * .35) * .5,z)
             .setAttr('rotation', 'z', a)
             .setAttr('scale', 'x', s)
             .setAttr('scale', 'y', s)
             .setAttr('size', 'x', window.innerWidth * .35)
             .setAttr('size', 'y', window.innerWidth * .35)
             .applyStyle();
    cloud.addChild(cloudPart);
  }

  $cloud.css({"top": ( Math.random() * 100 ) + "%", "left":  ( Math.random() * 100 ) + "%"});
  cloud.setAttr('transform', 'z', ((Math.random() < 0.5 ? -1 : 1) * Math.random() * 100) + depth )
       .setAttr('size', 'x', window.innerWidth * .35)
       .setAttr('size', 'y', window.innerWidth * .35)
       .applyStyle();

  return cloud;
};

var cam = new css3d.Cam($('.cam')[0]);

var world = new css3d.Node($('.js-mother')[0]);

world.setAttr('size', 'x', window.innerWidth * .8)
      .setAttr('size', 'y', window.innerHeight * .8)
      .applyStyle();

var max = 0;
for(var j = 0; j < 50; j++) {
  max = j * 175;
  world.addChild( createCloud(1,5,max) );
}

cam.obj3d.addChild( world );

var i = 0;
function setSize() {
  world.setAttr('transform', 'x', window.innerWidth * -.4)
       .setAttr('transform', 'y', window.innerHeight * -.4);
}
setSize();

$(window).on('resize', setSize);

var speed = 0.75;
var max = -max;
var direction = -1;


function loop (){
  i = i + (direction * speed);
  world.setAttr('transform', 'z', i);
  world.applyStyle();
  world.children.forEach(function(cloudy){
    cloudy.setRelative('rotation', 0,0, .025).applyStyle();
  });
  if(i < max && direction == -1) {
    direction = 1;
  }
  if(i < 200) {
    requestAnimationFrame(loop);
  }
};

loop();
</script>
</body></html>
